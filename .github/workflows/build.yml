name: CI/CD Pipeline On PR Merged

on:
   [pull_request]
    # push:
    #     branches:
    #       - main

jobs:
  test-and-package:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout
        uses: actions/checkout@v3
    
      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '18.x'

      - name: Create user.csv
        run: |
          touch user.csv
          echo "${{secrets.USER_CSV}}" >> user.csv

      - name: Build application artifact
        run: zip -r webapp.zip .   
      
      - name: list files
        run: ls -al
        
      - name: Configure AWS credentials dev
        uses: aws-actions/configure-aws-credentials@v1
        with:
          aws-access-key-id: ${{ secrets.ACCESS_KEY }}   
          aws-secret-access-key: ${{ secrets.SECRET_ACCESS_KEY }}
          aws-region: us-east-1
          
      - name: Initialize packer configuration
        run: packer init webapp.pkr.hcl
        
      - name: Build AMI with Packer
        run: packer build webapp.pkr.hcl
        env:
          PKR_VAR_database_pass: ${{secrets.DB_PASSWORD}} 
          PKR_VAR_database_user: ${{secrets.DB_USERNAME}}
          PKR_VAR_database_host: ${{secrets.DB_HOST}} 
          PKR_VAR_aws_region: "${{secrets.AWS_REGION}}"
          PKR_VAR_source_ami: "${{secrets.SOURCE_AMI}}"
          PKR_VAR_subnet_id: "${{secrets.SUBNET_ID}}"

      - name: Fetch latest AMI ID
        id: fetch_ami
        run: |
          AMI_ID=$(aws ec2 describe-images --owners self --filters "Name=tag:YourTagName,Values=YourTagValue" --query 'Images | sort_by(@, &CreationDate) | [-1].ImageId' --output text)
          echo "Latest AMI ID: $AMI_ID"
          echo "::set-output name=AMI_ID::$AMI_ID"
        env:
          AWS_ACCESS_KEY_ID: ${{ secrets.ACCESS_KEY }}
          AWS_SECRET_ACCESS_KEY: ${{ secrets.SECRET_ACCESS_KEY }}
          AWS_REGION: us-east-1
      
      # - name: Configure AWS credentials demo
      #   uses: aws-actions/configure-aws-credentials@v1
      #   with:
      #     aws-access-key-id: ${{ secrets.ACCESS_KEY_DEMO }}   
      #     aws-secret-access-key: ${{ secrets.SECRET_ACCESS_KEY_DEMO }}
      #     aws-region: us-east-1
    
