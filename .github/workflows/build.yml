name: CI/CD Pipeline On PR Merged

on:
   [pull_request]
    # push:
    #     branches:
    #       - main

jobs:
  test-and-package:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout
        uses: actions/checkout@v3
    
      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '18.x'

      - name: Create user.csv
        run: |
          touch user.csv
          echo "${{secrets.USER_CSV}}" >> user.csv

      - name: Build application artifact
        run: zip -r webapp.zip .   
      
      - name: list files
        run: ls -al
        
      - name: Configure AWS credentials dev
        uses: aws-actions/configure-aws-credentials@v1
        with:
          aws-access-key-id: ${{ secrets.ACCESS_KEY }}   
          aws-secret-access-key: ${{ secrets.SECRET_ACCESS_KEY }}
          aws-region: us-east-1
          
      - name: Initialize packer configuration
        run: packer init webapp.pkr.hcl
        
      - name: Build AMI with Packer
        run: |
            PACKER_OUTPUT=$(packer build webapp.pkr.hcl)
            AMI_ID=$(echo "$PACKER_OUTPUT" | grep -oP 'AMI: \K(ami-[a-zA-Z0-9]+)')
            echo "AMI_ID=$AMI_ID" >> $GITHUB_ENV
            echo "::set-output name=ami_id::$AMI_ID"
        env:
          PKR_VAR_database_pass: ${{secrets.DB_PASSWORD}} 
          PKR_VAR_database_user: ${{secrets.DB_USERNAME}}
          PKR_VAR_database_host: ${{secrets.DB_HOST}} 
          PKR_VAR_aws_region: "${{secrets.AWS_REGION}}"
          PKR_VAR_source_ami: "${{secrets.SOURCE_AMI}}"
          PKR_VAR_subnet_id: "${{secrets.SUBNET_ID}}"

      
      # - name: Configure AWS credentials demo
      #   uses: aws-actions/configure-aws-credentials@v1
      #   with:
      #     aws-access-key-id: ${{ secrets.ACCESS_KEY_DEMO }}   
      #     aws-secret-access-key: ${{ secrets.SECRET_ACCESS_KEY_DEMO }}
      #     aws-region: us-east-1
    
